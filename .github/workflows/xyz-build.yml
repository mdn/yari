name: XYZ Build (GCP)

on:
  push:
    branches:
      - gcp

  workflow_call:
    secrets:
      GCP_PROJECT_NAME:
        required: true
      GCS_BUCKET:
        required: true
      WIP_PROJECT_ID:
        required: true
jobs:
  build:
    environment: xyz
    permissions:
      contents: read
      id-token: write

    runs-on: ubuntu-latest-4core

    env:
      BUCKET_PATH: main

    # Only run the scheduled workflows on the main repo.
    if: github.repository == 'mdn/yari'

    steps:
      - uses: actions/checkout@v3

      - uses: actions/checkout@v3
        with:
          repository: mdn/content
          path: mdn/content
          # Yes, this means fetch EVERY COMMIT EVER.
          # It's probably not sustainable in the far future (e.g. past 2021)
          # but for now it's good enough. We'll need all the history
          # so we can figure out each document's last-modified date.
          fetch-depth: 0

      - uses: actions/checkout@v3
        with:
          repository: mdn/translated-content
          path: mdn/translated-content
          # See matching warning for mdn/content checkout step
          fetch-depth: 0

      - uses: actions/checkout@v3
        with:
          repository: mdn/mdn-contributor-spotlight
          path: mdn/mdn-contributor-spotlight

      - name: Setup Node.js environment
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: yarn

      - name: Install all yarn packages
        run: yarn --frozen-lockfile

      - name: Print information about CPU
        run: cat /proc/cpuinfo

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v0
        with:
          token_format: access_token
          service_account: deploy-xyz-yari@${{ secrets.GCP_PROJECT_NAME }}.iam.gserviceaccount.com
          workload_identity_provider: projects/${{ secrets.WIP_PROJECT_ID }}/locations/global/workloadIdentityPools/github-actions/providers/github-actions

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1

      - name: Build Function
        working-directory: gcp/function
        env:
          CONTENT_ROOT: ${{ github.workspace }}/mdn/content/files
          CONTENT_TRANSLATED_ROOT: ${{ github.workspace }}/mdn/translated-content/files
        run: |
          npm ci
          npm run build

      - name: Deploy Function
        uses: google-github-actions/deploy-cloud-functions@v1
        with:
          name: ${{ vars.GCP_FUNCTION_NAME }}
          runtime: nodejs18
          entry_point: mdnHandler
          memory_mb: 256
          region: europe-west3
          source_dir: gcp/function
          env_vars: |-
            ORIGIN_MAIN=${{ vars.ORIGIN_MAIN }}
            ORIGIN_LIVE_SAMPLES=${{ vars.ORIGIN_LIVE_SAMPLES }}
            SOURCE_CONTENT=https://storage.googleapis.com/${{ vars.GCP_BUCKET_NAME }}/${{ env.BUCKET_PATH }}/
            SOURCE_RUMBA=https://developer.allizom.org/
          secret_environment_variables: |-
            KEVEL_SITE_ID=projects/${{ secrets.WIP_PROJECT_ID }}/secrets/stage-kevel-site-id/versions/latest
            KEVEL_NETWORK_ID=projects/${{ secrets.WIP_PROJECT_ID }}/secrets/stage-kevel-network-id/versions/latest
            SIGN_SECRET=projects/${{ secrets.WIP_PROJECT_ID }}/secrets/stage-sign-secret/versions/latest
            CARBON_ZONE_KEY=projects/${{ secrets.WIP_PROJECT_ID }}/secrets/stage-carbon-zone-key/versions/latest
            CARBON_FALLBACK_ENABLED=projects/${{ secrets.WIP_PROJECT_ID }}/secrets/stage-fallback-enabled/versions/latest
