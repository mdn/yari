name: XYZ Build (GCP)

on:
  push:
    branches:
      - gcp

  workflow_call:
    secrets:
      GCP_PROJECT_NAME:
        required: true
      GCS_BUCKET:
        required: true
      WIP_PROJECT_ID:
        required: true
jobs:
  build:
    environment: xyz
    permissions:
      contents: read
      id-token: write

    runs-on: ubuntu-latest

    # Only run the scheduled workflows on the main repo.
    if: github.repository == 'mdn/yari'

    steps:
      - uses: actions/checkout@v3

      - uses: actions/checkout@v3
        with:
          repository: mdn/content
          path: mdn/content

      - uses: actions/checkout@v3
        with:
          repository: mdn/translated-content
          path: mdn/translated-content

      - name: Print information about CPU
        run: cat /proc/cpuinfo

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v0
        with:
          token_format: access_token
          service_account: deploy-xyz-yari@${{ secrets.GCP_PROJECT_NAME }}.iam.gserviceaccount.com
          workload_identity_provider: projects/${{ secrets.WIP_PROJECT_ID }}/locations/global/workloadIdentityPools/github-actions/providers/github-actions

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: '${{ secrets.GCP_PROJECT_NAME }}'

      - name: Deploy Function
        env:
          CONTENT_ROOT: ${{ github.workspace }}/mdn/content/files
          CONTENT_TRANSLATED_ROOT: ${{ github.workspace }}/mdn/translated-content/files
          ORIGIN_MAIN: developer.allizom.xyz
          ORIGIN_LIVE_SAMPLES: yari-demos.developer.allizom.xyz
          SOURCE_CONTENT: https://storage.googleapis.com/fiji-mdn-content/
          SOURCE_CLIENT: https://storage.googleapis.com/fiji-mdn-content/
          SOURCE_INTERACTIVE_SAMPLES: https://storage.googleapis.com/fiji-mdn-interactive-examples/
        working-directory: gcp/function
        run: |
          npm ci
          npm run build
          npm run deploy
