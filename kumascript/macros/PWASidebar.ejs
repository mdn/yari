<%

const sections = [
  {
    name: "Guides",
    contents: [
      "Guides/Making_PWAs_installable",
      "Guides/Offline_and_background_operation",
      "Guides/Structural_overview",
    ],
  },
  {
    name: "Tutorials",
    contents: [
      {
        name: "Tutorials/js13kGames",
        contents: [
          "Tutorials/js13kGames/Introduction",
          "Tutorials/js13kGames/App_structure",
          "Tutorials/js13kGames/Offline_Service_workers",
          "Tutorials/js13kGames/Installable_PWAs",
          "Tutorials/js13kGames/Re-engageable_Notifications_Push",
          "Tutorials/js13kGames/Loading",
        ],
      },
    ],
  },
  {
    name: "How_to",
    contents: [
      "How_to/Create_a_standalone_app",
      "How_to/Customize_your_app_colors",
      "How_to/Display_badge_on_app_icon",
    ],
  },
  {
    name: "Reference",
    contents: [],
  },
];

const sidebarURL = `/docs/Web/Progressive_web_apps/`;
const baseURL = `/${env.locale}${sidebarURL}`;

async function getTitle(pageSlug) {
  let page = await wiki.getPage(`${baseURL}${pageSlug}`);
  if (!page.title) {
    page = await wiki.getPage(`/en-US${sidebarURL}${pageSlug}`);
  }
  const title = page.short_title || page.title;
  return mdn.htmlEscape(title);
}

async function renderSubsection(subsection) {
  let output = `<li><details><summary>${await getTitle(
    subsection.name
  )}</summary><ol>`;

  output += (await Promise.all(subsection.contents.map(item => renderItem(item)))).join('');
  output += "</ol></details></li>";

  return output;
}

async function renderItem(item) {
  let output = "";
  if (typeof item === "string") {
    output += `<li><a href="${baseURL}${item}">${await getTitle(
      item
    )}</a></li>`;
  } else {
    output += `<li><ol>${await renderSubsection(item)}</ol></li>`;
  }
  return output;
}

async function renderSection(section) {
  let output = `<li><a href="${baseURL}${
    section.name
  }"><strong>${await getTitle(section.name)}</strong></a></li>`;

  for (const item of section.contents) {
    output += await renderItem(item);
  }

  return output;
}

async function renderSidebar() {
  let output = '<section id="Quick_links" data-macro="PWASidebar"><ol>';

  output += `<li><a href="${baseURL}"><strong>${await getTitle(
    ""
  )}</strong></a></li>`;

  for (const section of sections) {
    output += await renderSection(section);
  }
  output += "</ol></section>";

  return output;
}

const output = await renderSidebar();

%>

<%-output%>
