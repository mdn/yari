<%
/*
  Draws an SVG diagram to display an interface's inheritance chain

  $0 - Interface name (defaults to the interface page the macro is called on)

  Test pages

    - http://localhost:3000/en-US/docs/Web/API/SVGTextPositioningElement
    - http://localhost:3000/en-US/docs/Web/API/WheelEvent
    - http://localhost:3000/en-US/docs/Web/API/USB/connect_event
*/

const data = web.getJSONData("InterfaceData")[0];
const href = `/${env.locale}/docs/Web/API/`;
const mainInterfaceName = $0 || env.slug.replace('Web/API/','').split('/')[0];

let height = 40;
let offset = 0;
let xpos = 1;
let ypos = 1;

let inheritanceChain = [mainInterfaceName];
let inh = data[mainInterfaceName] != undefined ? data[mainInterfaceName].inh : '';

function getInheritance(inh) {
  if (inh !== '') {
    inheritanceChain.unshift(inh);
    if (data[inh]) {
        inh = data[inh].inh;
        getInheritance(inh);
    }
  }
}
getInheritance(inh);

function rectWithText(x, y, fill, interfaceName, reverse) {
  const rectWidth = interfaceName.length * 8 < 75 ? 75 : interfaceName.length * 8;
  if (reverse) {
    xpos -= rectWidth;
    x = xpos;
  } else {
    xpos += rectWidth;
  }
  return `
  <a style="text-decoration: none;" xlink:href="${href+interfaceName}">
    <rect x="${x}" y="${y}" width="${rectWidth}" height="25" fill="${fill}" stroke="#D4DDE4" stroke-width="2px" />
    <text x="${x+rectWidth/2}" y="${y+16}" font-size="10px" fill="#4D4E53" text-anchor="middle">
      ${interfaceName}
    </text>
  </a>`;
}

function lineWithTriangle(x, y, reverse) {
  const length = reverse ? -30 : 30;
  return `
  <line x1="${x}" y1="${y}" x2="${x+length}" y2="${y}" stroke="#D4DDE4""/>
  ${triangle(x, y, reverse)}`;
}

function connectingLineWithTriangle() {
  let str = '';

  str += triangle(xpos, ypos + 14);
  xpos += 10;
  str += `<line x1="${xpos}" y1="${ypos+14}" x2="${xpos+8}" y2="${ypos+14}" stroke="#D4DDE4"/>`;
  xpos += 8;
  str += `<line x1="${xpos}" y1="${ypos+14}" x2="${xpos}" y2="${ypos+59}" stroke="#D4DDE4"/>`;
  ypos = 60;
  str += `<line x1="${xpos}" y1="${ypos}" x2="${xpos-17}" y2="${ypos}" stroke="#D4DDE4"/>`;

  return str;
}

function triangle(x, y, reverse) {
  const width = reverse ? -10 : 10;
  return `<polyline points="${x},${y} ${x+width},${y-5} ${x+width},${y+5} ${x},${y}" stroke="#D4DDE4" fill="#fff"/>`;
}

function drawDiagram(inheritanceChain) {
  let str = '';
  for (let i = 0; i < inheritanceChain.length; i++) {
    const fill = (inheritanceChain[i] == mainInterfaceName) ? '#F4F7F8': '#fff';
    // we are going to the second row with a connecting line
    if (i === 4) {
      str += connectingLineWithTriangle();
      xpos -= 18;
      ypos = 47;
    }
    // first row
    if (i < 4) {
      str += rectWithText(xpos, ypos, fill, inheritanceChain[i]);
      if (i != inheritanceChain.length - 1 && i != 3) {
        str += lineWithTriangle(xpos, ypos + 14);
        xpos += 30;
      }
    // second row
    } else {
      height = 80; // need more space
      str += rectWithText(xpos, ypos, fill, inheritanceChain[i], true);
      if (i != inheritanceChain.length - 1) {
        str += lineWithTriangle(xpos, ypos + 14, true);
        xpos -= 30;
      }
      if (xpos < 0) {
        // prevent cut off in case of a really long chain (see e.g. SVGTextPositioningElement)
        offset = 1 + Math.abs(xpos);
      }
    }
  }
  return str;
}

let output = '';

if (inheritanceChain.length > 1) {
  let diagram = drawDiagram(inheritanceChain); // needs to run first to calculate offset and height
  output = `<svg viewbox="-${offset} 0 650 ${height}" preserveAspectRatio="xMinYMin meet">`;
  output += diagram;
  output +='</svg>';
}

%>
<%-output%>
